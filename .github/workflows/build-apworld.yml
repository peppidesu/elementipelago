name: Build Elementipelago APWorld and attach to Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout apworld (itepastra/Archipelago@elemetipelago)
        uses: actions/checkout@v4
        with:
          repository: itepastra/Archipelago
          ref: elemetipelago
          path: apworld

      - name: Checkout game
        uses: actions/checkout@v4
        with:
          path: game

      - name: Package .apworld
        shell: bash
        run: |
          set -euo pipefail

          WORLD_NAME="elementipelago"
          SRC_DIR="apworld/worlds/${WORLD_NAME}"
          OUT_DIR="${PWD}/dist"
          mkdir -p "$OUT_DIR"

          # APWorld spec: zip must contain a top-level folder with the SAME name as the apworld (case-sensitive)
          # We'll stage it so the zip root is: elementipelago/...
          STAGE="$(mktemp -d)"
          mkdir -p "${STAGE}/${WORLD_NAME}"
          rsync -a --delete \
            --exclude="__pycache__/" \
            --exclude="*.pyc" \
            "${SRC_DIR}/" "${STAGE}/${WORLD_NAME}/"

          ASSET_BASENAME="${WORLD_NAME}"
          ZIP_PATH="${OUT_DIR}/${ASSET_BASENAME}.zip"
          APWORLD_PATH="${OUT_DIR}/${ASSET_BASENAME}.apworld"

          (cd "$STAGE" && zip -r -9 "${ZIP_PATH}" "${WORLD_NAME}")
          mv "${ZIP_PATH}" "${APWORLD_PATH}"

          echo "Built ${APWORLD_PATH}"
          ls -lah "${OUT_DIR}"


      - name: Upload .apworld to the GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          pushd game
          TAG="${GITHUB_REF_NAME}"
          gh release upload "$TAG" ../dist/*.apworld --clobber
          popd
